<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ntu.lottery.mapper.TaskMessageMapper">

    <insert id="insert" parameterType="com.ntu.lottery.entity.TaskMessage" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO task_message (biz_type, biz_id, topic, payload, state, retry_count, next_retry_time, last_error)
        VALUES (#{bizType}, #{bizId}, #{topic}, #{payload}, #{state}, #{retryCount}, #{nextRetryTime}, #{lastError})
    </insert>

    <select id="selectById" resultType="com.ntu.lottery.entity.TaskMessage">
        SELECT id,
               biz_type AS bizType,
               biz_id AS bizId,
               topic,
               payload,
               state,
               retry_count AS retryCount,
               next_retry_time AS nextRetryTime,
               last_error AS lastError,
               created_at AS createdAt,
               updated_at AS updatedAt
        FROM task_message
        WHERE id = #{id}
    </select>

    <update id="markSuccess">
        UPDATE task_message
        SET state = 'SUCCESS',
            last_error = NULL
        WHERE id = #{id}
    </update>

    <update id="markFail">
        UPDATE task_message
        SET state = 'FAIL',
            last_error = #{lastError},
            next_retry_time = #{nextRetryTime}
        WHERE id = #{id}
    </update>

    <update id="touchRetry">
        UPDATE task_message
        SET retry_count = retry_count + 1,
            next_retry_time = #{nextRetryTime}
        WHERE id = #{id}
    </update>

    <select id="scanRetryTasks" resultType="com.ntu.lottery.entity.TaskMessage">
        SELECT id,
               biz_type AS bizType,
               biz_id AS bizId,
               topic,
               payload,
               state,
               retry_count AS retryCount,
               next_retry_time AS nextRetryTime,
               last_error AS lastError,
               created_at AS createdAt,
               updated_at AS updatedAt
        FROM task_message
        WHERE (state = #{state1} OR state = #{state2})
          AND next_retry_time &lt;= #{now}
        ORDER BY next_retry_time ASC
        LIMIT #{limit}
    </select>

</mapper>
