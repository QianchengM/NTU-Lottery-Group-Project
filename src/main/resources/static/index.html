<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NTU Lottery System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding-top: 20px; }
        .lottery-card {
            background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 30px; text-align: center; margin-bottom: 20px;
        }
        .prize-list { text-align: left; margin-top: 20px; }
        .btn-draw { width: 100%; padding: 15px; font-size: 24px; font-weight: bold; margin-top: 20px; }
        /* æ’è¡Œæ¦œæ ·å¼ */
        .leaderboard-box { background: #212529; color: gold; padding: 15px; border-radius: 10px; height: 150px; overflow: hidden; }
        .marquee { animation: scrollUp 10s linear infinite; }
        @keyframes scrollUp { 
            0% { transform: translateY(100%); } 
            100% { transform: translateY(-100%); } 
        }
        /* ä¾§è¾¹æ å¡ç‰‡ */
        .side-card { background: white; border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

<nav class="container mb-4 d-flex justify-content-between align-items-center">
    <h3 class="fw-bold">ğŸ NTU Lottery</h3>
    <div class="d-flex align-items-center gap-3">
        <span>User: <strong>Alice</strong> (Code: A001)</span>
        <span class="badge bg-warning text-dark fs-6">Points: <span id="userPoints">Loading...</span></span>
        <button onclick="doCheckIn()" class="btn btn-sm btn-outline-success">ğŸ“… Check-in (+50)</button>
        <a href="/mall.html" class="btn btn-sm btn-primary">ğŸ›ï¸ Mall</a>
        <a href="/history.html" class="btn btn-sm btn-info text-white">ğŸ“œ History</a>
        <a href="/admin.html" class="btn btn-sm btn-secondary">Admin</a>
    </div>
</nav>

<div class="container">
    <div class="row">
        <div class="col-md-8">
            <div class="lottery-card">
                <h2 class="mb-3">ğŸ‰ Semester End Lucky Draw</h2>
                <p class="text-danger fw-bold">Cost: 50 Points / Draw</p>
                <hr>
                <div class="prize-list">
                    <h5>ğŸ† Prize List:</h5>
                    <ul id="prizeListUi" class="list-group list-group-flush">
                        <li class="list-group-item text-muted">Loading prizes...</li>
                    </ul>
                </div>
                <button id="drawBtn" class="btn btn-primary btn-draw" onclick="startLottery()">ğŸ² DRAW NOW</button>
            </div>
            
            <div id="resultArea" class="mt-3 text-center" style="display:none;">
                <div class="alert alert-success fs-4" id="resultMessage"></div>
            </div>
        </div>

        <div class="col-md-4">
            
            <div class="side-card">
                <h5>ğŸ¤ Invite & Earn</h5>
                <p class="text-muted small">Enter friend's code to get 50 pts.</p>
                <div class="input-group mb-2">
                    <input type="text" id="inviteCodeInput" class="form-control" placeholder="e.g. B002">
                    <button class="btn btn-success" onclick="submitInvite()">Submit</button>
                </div>
                <small class="text-muted">Your Code: <strong>A001</strong></small>
            </div>

            <div class="side-card bg-dark text-white">
                <h5 class="text-warning">ğŸ† Big Winners</h5>
                <div class="leaderboard-box">
                    <div id="marqueeList" class="marquee">
                        <div>Loading winners...</div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // åˆå§‹åŒ–åŠ è½½
    window.onload = function() {
        loadPrizes();
        loadLeaderboard();
        loadUserPoints();
    };

    // 1. æ¨¡æ‹ŸåŠ è½½ç§¯åˆ† (å®é™…åº”è¯¥èµ°API)
    function loadUserPoints() {
        // è¿™é‡Œåªæ˜¯Demoæ¼”ç¤ºï¼Œå®é™…åº”è¯¥ fetch('/user/info')
        let current = document.getElementById('userPoints').innerText;
        if(current === "Loading...") document.getElementById('userPoints').innerText = 1000; 
    }

    // 2. åŠ è½½å¥–å“
    function loadPrizes() {
        fetch('/prizes').then(r=>r.json()).then(data => {
            const list = document.getElementById('prizeListUi');
            list.innerHTML = '';
            data.filter(p => p.activity_id === 1).forEach(prize => {
                let badge = prize.stock > 0 ? 'bg-success' : 'bg-secondary';
                list.innerHTML += `
                    <li class="list-group-item d-flex justify-content-between">
                        ${prize.name}
                        <span class="badge ${badge} rounded-pill">Stock: ${prize.stock}</span>
                    </li>`;
            });
        });
    }

    // 3. æ ¸å¿ƒæŠ½å¥–åŠŸèƒ½
    function startLottery() {
        const btn = document.getElementById('drawBtn');
        const resultArea = document.getElementById('resultArea');
        const msg = document.getElementById('resultMessage');
        
        btn.disabled = true; btn.innerHTML = 'Thinking...'; resultArea.style.display = 'none';

        fetch('/draw?userId=1&activityId=1').then(r=>r.text()).then(text => {
            resultArea.style.display = 'block';
            msg.innerText = text;
            msg.className = text.includes("Congratulations") ? 'alert alert-success fw-bold fs-4' : 'alert alert-secondary fs-4';
            
            // æ‰£åˆ†è§†è§‰æ•ˆæœ
            let pts = document.getElementById('userPoints');
            pts.innerText = parseInt(pts.innerText) - 50;

            btn.disabled = false; btn.innerHTML = 'ğŸ² DRAW AGAIN';
            loadPrizes(); // åˆ·æ–°åº“å­˜
            if(text.includes("Congratulations")) loadLeaderboard(); // å¦‚æœä¸­å¥–ï¼Œåˆ·æ–°æ’è¡Œæ¦œ
        });
    }

    // 4. æ¯æ—¥ç­¾åˆ°åŠŸèƒ½
    function doCheckIn() {
        fetch('/daily/checkin?userId=1').then(r=>r.text()).then(msg => {
            alert(msg);
            if(msg.includes("Success")) {
                let pts = document.getElementById('userPoints');
                pts.innerText = parseInt(pts.innerText) + 50;
            }
        });
    }

    // 5. æäº¤é‚€è¯·ç 
    function submitInvite() {
        const code = document.getElementById('inviteCodeInput').value;
        if(!code) return alert("Please enter a code!");
        
        fetch(`/invite/submit?userId=1&code=${code}`).then(r=>r.text()).then(msg => {
            alert(msg);
            if(msg.includes("Success")) {
                let pts = document.getElementById('userPoints');
                pts.innerText = parseInt(pts.innerText) + 50;
            }
        });
    }

    // 6. åŠ è½½æ’è¡Œæ¦œ
    function loadLeaderboard() {
        fetch('/leaderboard').then(r=>r.json()).then(data => {
            const box = document.getElementById('marqueeList');
            box.innerHTML = '';
            if(data.length === 0) {
                box.innerHTML = '<div class="text-muted">No winners yet... Be the first!</div>';
                return;
            }
            data.forEach(record => {
                // æ ¼å¼åŒ–æ—¶é—´ï¼Œåªå–æ—¶åˆ†ç§’
                let time = record.create_time ? record.create_time.split('T')[1].split('.')[0] : 'Just now';
                box.innerHTML += `
                    <div class="mb-2">
                        <span class="fw-bold text-white">${record.username}</span> 
                        won <span class="text-warning">${record.prize_name}</span>
                        <br><small class="text-muted" style="font-size:0.8em">${time}</small>
                    </div>
                `;
            });
        });
    }
</script>
</body>
</html>