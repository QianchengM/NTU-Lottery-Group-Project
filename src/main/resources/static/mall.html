<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Points Mall - NTU Lottery</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; padding: 20px; }
        .product-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            transition: transform 0.2s; /* é¼ æ ‡æ”¾ä¸Šå»åŠ¨ä¸€ä¸‹ï¼Œå¢åŠ é«˜çº§æ„Ÿ */
        }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .price-tag { color: #d9534f; font-weight: bold; font-size: 1.2em; }
    </style>
</head>
<body>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>ğŸ›ï¸ Points Redemption Mall</h1>
        <div>
            <span class="me-3 fs-5">User: <strong>Alice</strong></span>
            <span class="badge bg-warning text-dark fs-5">Points: <span id="myPoints">Loading...</span></span>
        </div>
    </div>

    <a href="/" class="btn btn-outline-primary mb-4">â† Back to Lottery</a>

    <div class="row" id="productList">
        </div>
</div>

<script>
    // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
    window.onload = function() {
        refreshData();
    };

    function refreshData() {
        // 1. è·å–ç”¨æˆ·ç§¯åˆ†
        // (è¿™é‡Œä¸ºäº†æ¼”ç¤ºç®€å•ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰å†™ä¸“é—¨æŸ¥ç”¨æˆ·çš„æ¥å£ï¼Œè€Œæ˜¯ç›´æ¥ç”¨ getAllPrizes é‡Œçš„å‡æ•°æ®æˆ–è€…åç»­è¡¥ï¼Œ
        // æš‚æ—¶æˆ‘ä»¬å…ˆå‡è®¾å‰ç«¯è‡ªå·±ç»´æŠ¤æ˜¾ç¤ºï¼Œå®é™…é€»è¾‘æ˜¯åç«¯ exchange æ¥å£æ§åˆ¶çš„)
        // æ­£å¸¸æ¯•è®¾åº”è¯¥å†™ä¸ª /user/info æ¥å£ï¼Œä½†ä¸ºäº†å·æ‡’ï¼Œæˆ‘ä»¬å‡è®¾ Alice åˆå§‹å¾ˆå¤šåˆ†ï¼Œæˆ–è€…ä»é¡µé¢å‚æ•°è¯»
        document.getElementById('myPoints').innerText = "Check DB"; 
        
        // 2. è·å–å•†å“åˆ—è¡¨
        fetch('/prizes')
            .then(res => res.json())
            .then(data => {
                const container = document.getElementById('productList');
                container.innerHTML = '';
                
                // è¿‡æ»¤æ‰ "è°¢è°¢æƒ é¡¾" è¿™ç§éå•†å“
                const goods = data.filter(p => p.type !== 0); 

                goods.forEach(p => {
                    // å¦‚æœ point_cost å­—æ®µè¿˜æ²¡åˆ·æ–°å‡ºæ¥(å¯èƒ½æ˜¯null)ï¼Œå°±é»˜è®¤æ˜¾ç¤º 100
                    const price = p.point_cost || 100;
                    
                    container.innerHTML += `
                        <div class="col-md-4">
                            <div class="product-card text-center">
                                <h4>${p.name}</h4>
                                <p class="text-muted">Stock: ${p.stock}</p>
                                <p class="price-tag">${price} Points</p>
                                <button onclick="buyItem(${p.id}, '${p.name}')" class="btn btn-primary w-100">
                                    Exchange Now
                                </button>
                            </div>
                        </div>
                    `;
                });
            });
    }

    function buyItem(id, name) {
        if(!confirm(`Confirm to exchange "${name}"?`)) return;

        // è°ƒç”¨åç«¯è´­ä¹°æ¥å£ (UserId=1 æ˜¯ Alice)
        fetch(`/mall/exchange?userId=1&prizeId=${id}`)
            .then(res => res.text())
            .then(msg => {
                alert(msg); // å¼¹çª—æ˜¾ç¤ºç»“æœ (æˆåŠŸæˆ–ç§¯åˆ†ä¸è¶³)
                refreshData(); // åˆ·æ–°é¡µé¢æ•°æ®
            });
    }
</script>

</body>
</html>