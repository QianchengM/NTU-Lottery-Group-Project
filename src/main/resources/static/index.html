<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NTU Lottery System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding-top: 50px; }
        .lottery-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 30px;
            text-align: center;
        }
        .prize-list { text-align: left; margin-top: 20px; }
        .btn-draw {
            width: 100%;
            padding: 15px;
            font-size: 24px;
            font-weight: bold;
            margin-top: 20px;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="alert alert-info d-flex justify-content-between align-items-center">
                <span>User: <strong>Alice</strong></span>
                <span>Points: <strong id="userPoints">1000</strong></span>
            </div>

            <div class="lottery-card">
                <h2 class="mb-3">üéâ Semester End Lucky Draw</h2>
                <p class="text-muted">Win an iPhone 15 Pro or Grab Vouchers!</p>
                <p class="text-danger">Cost: 50 Points / Draw</p>
                
                <hr>
                
                <div class="prize-list">
                    <h5>üèÜ Prize List:</h5>
                    <ul id="prizeListUi" class="list-group list-group-flush">
                        <li class="list-group-item text-muted">Loading prizes...</li>
                    </ul>
                </div>

                <button id="drawBtn" class="btn btn-primary btn-draw" onclick="startLottery()">
                    üé≤ DRAW NOW
                </button>
            </div>
            
            <div id="resultArea" class="mt-3 text-center" style="display:none;">
                <div class="alert alert-success" id="resultMessage"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. Load Prizes when page opens
    window.onload = function() {
        fetch('/prizes')
            .then(response => response.json())
            .then(data => {
                const list = document.getElementById('prizeListUi');
                list.innerHTML = ''; // Clear loading text
                
                // Filter only prizes for Activity 1
                const activity1Prizes = data.filter(p => p.activity_id === 1);
                
                activity1Prizes.forEach(prize => {
                    let badge = 'bg-secondary';
                    if(prize.name.includes('iPhone')) badge = 'bg-danger';
                    if(prize.name.includes('Voucher')) badge = 'bg-success';
                    
                    list.innerHTML += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            ${prize.name}
                            <span class="badge ${badge} rounded-pill">Stock: ${prize.stock}</span>
                        </li>
                    `;
                });
            });
    };

    // 2. The Draw Function
    function startLottery() {
        const btn = document.getElementById('drawBtn');
        const resultArea = document.getElementById('resultArea');
        const msg = document.getElementById('resultMessage');
        
        // Disable button to prevent double click
        btn.disabled = true;
        btn.innerHTML = 'Thinking...';
        resultArea.style.display = 'none';

        // Call our Java Backend
        // Hardcoded: userId=1 (Alice), activityId=1
        fetch('/draw?userId=1&activityId=1')
            .then(response => response.text())
            .then(text => {
                // Show Result
                resultArea.style.display = 'block';
                msg.innerText = text;
                
                // Style based on result
                if(text.includes("Congratulations")) {
                    msg.className = 'alert alert-success fw-bold';
                    // Reduce points visually (simple simulation)
                    let points = document.getElementById('userPoints');
                    points.innerText = parseInt(points.innerText) - 50;
                } else {
                    msg.className = 'alert alert-secondary';
                    // Reduce points even if failed
                    let points = document.getElementById('userPoints');
                    points.innerText = parseInt(points.innerText) - 50;
                }

                // Re-enable button
                btn.disabled = false;
                btn.innerHTML = 'üé≤ DRAW AGAIN';
                
                // Refresh prize list to update stock
                window.onload();
            })
            .catch(err => {
                alert("Error: " + err);
                btn.disabled = false;
            });
    }
</script>

</body>
</html>